<view class="container">
  <view class="food-image-container">
    <image class="food-image" src="{{foodRecord.imageUrl}}" mode="aspectFill"></image>
  </view>
  
  <!-- Opening stage: AI gives sarcastic opening -->
  <block wx:if="{{stage === 'opening'}}">
    <view class="opening-container">
      <view class="ai-bubble">
        <text class="ai-message">{{foodRecord.feedback.sarcasticOpening}}</text>
      </view>
      
      <view class="harsh-comment">
        不是很明白？我来告诉你这顿饭有多糟糕！
      </view>
      
      <button class="action-button" bindtap="onContinueFromOpening">
        <text>继续对话</text>
      </button>
    </view>
  </block>
  
  <!-- Response stage: User chooses a response type -->
  <block wx:elif="{{stage === 'response'}}">
    <view class="response-container">
      <view class="response-prompt">
        <text>你想说什么？</text>
      </view>
      
      <view class="options-container">
        <button class="response-button curious" bindtap="onCuriousResponse">
          <text>{{foodRecord.feedback.responseOptions.curious}}</text>
        </button>
        
        <button class="response-button defiant" bindtap="onDefiantResponse">
          <text>{{foodRecord.feedback.responseOptions.defiant}}</text>
        </button>
        
        <button class="response-button helpful" bindtap="onHelpfulResponse">
          <text>{{foodRecord.feedback.responseOptions.helpful}}</text>
        </button>
      </view>
      
      <view class="harsh-comment">
        别磨蹭了，快点回应！你的犹豫不决只会让你更胖。
      </view>
    </view>
  </block>
  
  <!-- Original question stage (kept for backward compatibility) -->
  <block wx:elif="{{stage === 'question'}}">
    <view class="question-container">
      <view class="question-title">你觉得这顿饭健康吗？</view>
      
      <view class="options-container">
        <button class="option-button" bindtap="onHealthyOption">
          <text>健康</text>
        </button>
        
        <button class="option-button" bindtap="onUnhealthyOption">
          <text>不健康</text>
        </button>
        
        <button class="option-button" bindtap="onUnsureOption">
          <text>不确定</text>
        </button>
      </view>
      
      <view class="harsh-comment">
        做决定的速度都这么慢？难怪健康管理做不好。快点选！
      </view>
    </view>
  </block>
  
  <!-- Feedback stage: AI provides feedback based on user response -->
  <block wx:elif="{{stage === 'feedback'}}">
    <view class="feedback-container">
      <!-- Show user response if we're in the new flow -->
      <view class="user-response" wx:if="{{userResponse}}">
        <text>你说: </text>
        <text class="user-response-text">{{foodRecord.feedback.responseOptions[userResponse]}}</text>
      </view>
      
      <!-- Show original opinion if we're in the old flow -->
      <view class="user-response" wx:elif="{{userOpinion}}">
        <text>你认为: </text>
        <text class="user-opinion">{{userOpinionText}}</text>
      </view>
      
      <!-- AI response based on user choice -->
      <view class="ai-response" wx:if="{{userResponse}}">
        <text class="response-prefix">{{foodRecord.feedback.responseReplies[userResponse]}}</text>
      </view>
      
      <!-- Original AI response for backward compatibility -->
      <view class="ai-response" wx:elif="{{userOpinion}}">
        <text wx:if="{{userOpinion === 'healthy'}}" class="response-prefix">你是认真的吗？这种垃圾也能叫健康？</text>
        <text wx:elif="{{userOpinion === 'unhealthy'}}" class="response-prefix">终于有点自知之明了，但知道又有什么用？</text>
        <text wx:else class="response-prefix">连这都不确定？我来告诉你事实。</text>
      </view>
      
      <!-- Common feedback elements -->
      <view class="sarcastic-comment">
        <text class="emoji" wx:if="{{foodRecord.feedback.isHealthy}}">👍</text>
        <text class="emoji" wx:else>👎</text>
        <text class="comment-text">{{foodRecord.feedback.sarcasticComment}}</text>
      </view>
      
      <view class="harsh-reaction" wx:if="{{!foodRecord.feedback.isHealthy}}">
        <view class="harsh-comment">
          听好了，这是为了你的健康着想。别抱怨，照做就是！
        </view>
      </view>
      
      <view class="advice-container">
        <view class="section-title" bindtap="toggleAdvice">
          建议: <text class="toggle-indicator">{{showFullAdvice ? '▼' : '▶'}}</text>
        </view>
        <view class="advice-list" wx:if="{{showFullAdvice}}">
          <view class="advice-item" wx:for="{{foodRecord.feedback.advice}}" wx:key="index">
            <text class="advice-marker">•</text>
            <text class="advice-text">{{item}}</text>
          </view>
        </view>
      </view>
      
      <view class="action-buttons">
        <button class="action-button accept" bindtap="onGotIt">
          <text>接受建议</text>
        </button>
        
        <button class="action-button ignore" bindtap="onIgnoreAdvice">
          <text>不想听</text>
        </button>
      </view>
    </view>
  </block>
</view> 